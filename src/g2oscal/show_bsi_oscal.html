<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>BSI-Grundschutz OSCAL Viewer</title>
<style>
/* ===== Variables & Basics ===== */
:root{--bg-color:#f8f9fa;--text-color:#212529;--primary-color:#004494;--secondary-color:#e9ecef;--border-color:#dee2e6;--card-bg:#fff;--shadow:0 2px 8px rgba(0,0,0,.1);--hover-bg:#f1f3f5}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg-color);color:var(--text-color);line-height:1.6;margin:0;padding:20px}
.container{max-width:1200px;margin:auto;background:var(--card-bg);padding:2rem;border-radius:8px;box-shadow:var(--shadow)}
h1,h2{color:var(--primary-color);border-bottom:2px solid var(--secondary-color);padding-bottom:10px}
/* ===== Form & Controls ===== */
textarea{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:4px;font-family:"Courier New",monospace;font-size:.9em;margin-bottom:1rem;box-sizing:border-box}
#json-input{height:250px}
button,.file-label{background:var(--primary-color);color:#fff;border:0;padding:12px 20px;border-radius:4px;cursor:pointer;font-size:1rem;transition:.2s;display:inline-block;text-align:center}
button:hover,.file-label:hover{background:#003366}
.hidden{display:none!important}
/* ===== Filter Bar ===== */
#filter-controls{background:var(--secondary-color);padding:1.5rem;margin-top:2rem;border-radius:8px;display:flex;flex-wrap:wrap;gap:1.5rem;align-items:center}
.filter-group,.view-group{display:flex;flex-direction:column;gap:5px}
label{font-weight:700;font-size:.9em;color:#495057}
input[type=text],select{padding:8px;border-radius:4px;border:1px solid var(--border-color);min-width:180px}
.view-switch{display:flex;gap:15px}.view-switch label{font-weight:400}
/* ===== Tree View ===== */
#tree-view-container details{margin-left:20px;border-left:2px solid var(--secondary-color);padding-left:15px;margin-top:5px}
#tree-view-container summary{cursor:pointer;padding:5px;border-radius:4px}
#tree-view-container summary:hover{background:var(--hover-bg)}
.main-group>summary{font-size:1.2em;font-weight:700}
.baustein-group>summary{font-size:1.1em;font-weight:500}
.bsi-control>summary{font-size:1.05em;background:#f8f9fa}
.maturity-level-description>summary{font-weight:700;margin-top:10px;background:#f1f3f5}
/* ===== Checklist ===== */
#checklist-container{display:flex;flex-direction:column;gap:1.5rem;margin-top:2rem}
.checklist-item{border:1px solid var(--border-color);border-radius:8px;box-shadow:var(--shadow);background:var(--card-bg)}
.checklist-item-header{background:#f8f9fa;padding:1rem 1.5rem;border-bottom:1px solid var(--border-color)}
.checklist-item-title{font-size:1.2em;font-weight:700;color:var(--primary-color);margin:0}
.checklist-item-path{font-size:.85em;color:#6c757d;margin-top:5px}
.checklist-item-body{padding:1.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem}
.input-group{display:flex;flex-direction:column}
.input-group textarea{height:80px;resize:vertical}
/* Part-Text */
.part-prose{border:1px solid var(--border-color);border-radius:4px;background:#fafafa;padding:8px;min-height:80px;white-space:pre-line}
/* Save/Load Box */
#saveload-controls{margin-top:2rem;padding:1.5rem;background:var(--secondary-color);border-radius:8px;display:flex;flex-direction:column;gap:1rem}
#saveload-controls .row{display:flex;gap:1rem;align-items:center}
#saveload-controls input[type=file]{display:none}
</style>
</head>
<body>
<div class="container">
<h1>BSI-GrdSchutz OSCAL Viewer</h1>
<p>Fügen Sie unten Ihren BSI-OSCAL-Katalog (JSON) ein …</p>

<textarea id="json-input">{ /* hier JSON einkopieren */ }</textarea>
<button id="render-btn">Katalog rendern</button>

<div id="status">Fügen Sie oben Ihr JSON ein …</div>

<!-- ========== FILTER-LEISTE ========== -->
<div id="filter-controls" class="hidden">
  <div class="filter-group">
    <label for="maturity-filter">Nach Reifegrad filtern</label>
    <select id="maturity-filter">
      <option value="all">Alle Reifegrade</option>
      <option>Partial</option><option>Foundational</option>
      <option>Defined</option><option>Enhanced</option><option>Comprehensive</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="level-filter">Nach Schutzbedarf filtern</label>
    <select id="level-filter">
      <option value="all">Alle Stufen</option>
      <option value="1">1 (Basis)</option>
      <option value="3">3 (Standard)</option>
      <option value="5">5 (Erhöhter)</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="phase-filter">Nach ISMS-Phase filtern</label>
    <select id="phase-filter">
      <option value="all">Alle Phasen</option>
      <option>Initiation</option><option>Risk Assessment</option><option>Risk Treatment</option>
      <option>Implementation</option><option>Operation</option><option>Audit</option><option>Improvement</option>
    </select>
  </div>
  <div class="view-group">
    <label>Ansichtsmodus</label>
    <div class="view-switch">
      <label><input type="radio" name="view-mode" value="tree" checked> Gefilterter Baum</label>
      <label><input type="radio" name="view-mode" value="checklist"> Checkliste</label>
    </div>
  </div>
  <button id="reset-btn">Filter zurücksetzen</button>
</div>

<!-- ========== AUSGABEN ========== -->
<div id="output-container">
  <div id="tree-view-container"></div>
  <div id="checklist-container" class="hidden"></div>

  <!-- Speichern / Laden -->
  <div id="saveload-controls" class="hidden">
    <div class="input-group">
      <label for="prüfer-name">Prüfername</label>
      <input type="text" id="prüfer-name" placeholder="Ihr Name">
    </div>
    <div class="row">
      <button id="save-btn">Checkliste Speichern</button>
      <label for="load-input" class="file-label">Checkliste Laden</label>
      <input type="file" id="load-input" accept=".json">
    </div>
  </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* ========= Element-Referenzen ========= */
const jsonInput=document.getElementById('json-input'),
      statusEl=document.getElementById('status'),
      renderBtn=document.getElementById('render-btn'),
      resetBtn=document.getElementById('reset-btn'),
      filterControls=document.getElementById('filter-controls'),
      saveLoadControls=document.getElementById('saveload-controls'),
      maturityFilter=document.getElementById('maturity-filter'),
      levelFilter=document.getElementById('level-filter'),
      phaseFilter=document.getElementById('phase-filter'),
      viewModeRadios=document.querySelectorAll('input[name="view-mode"]'),
      treeViewContainer=document.getElementById('tree-view-container'),
      checklistContainer=document.getElementById('checklist-container'),
      saveBtn=document.getElementById('save-btn'),
      loadInput=document.getElementById('load-input'),
      prüferNameInput=document.getElementById('prüfer-name');

/* ========= Hilfsfunktionen ========= */
let catalogData=null;
const findPropValue=(props,name)=>(props||[]).find(p=>p.name===name)?.value||'';
const formatIdTitle=i=>`${i.id}: ${i.title}`;

/* ======== Checklist Item ======== */
const renderChecklistItem=(ctrl,mainGrp,bsGrp)=>{
  const title=formatIdTitle(ctrl),
        path=`${mainGrp.title||mainGrp.id} &raquo; ${formatIdTitle(bsGrp)}`;

  /* Parts je Reifegrad sammeln */
  const maturityParts={};
  (ctrl.parts||[]).forEach(mp=>{
    if(mp.name==='maturity-level-description'){
      const level=findPropValue(mp.props,'maturity-level');
      maturityParts[level]={};
      (mp.parts||[]).forEach(p=>maturityParts[level][p.name]=p.prose||'');
    }
  });
  const maturities=Object.keys(maturityParts);

  const div=document.createElement('div');
  div.className='checklist-item';
  div.dataset.controlId=ctrl.id;
  div.dataset.level=findPropValue(ctrl.props,'level');
  div.dataset.phase=findPropValue(ctrl.props,'phase');
  div.dataset.maturities=maturities.join(',');

  div.innerHTML=`
    <div class="checklist-item-header">
      <h3 class="checklist-item-title">${title}</h3>
      <div class="checklist-item-path">${path}</div>
    </div>
    <div class="checklist-item-body">
      <div class="input-group">
        <label>Reifegrad wählen</label>
        <select class="maturity-select">
          <option value="">Nicht ausgewählt</option>
          ${maturities.map(m=>`<option>${m}</option>`).join('')}
        </select>
      </div>
      <div class="input-group">
        <label>Teil wählen</label>
        <select class="part-select">
          <option value="">–</option>
          <option value="statement">Statement</option>
          <option value="guidance">Guidance</option>
          <option value="assessment-method">Assessment-Method</option>
        </select>
      </div>
      <div class="input-group">
        <label>Inhalt</label>
        <div class="part-prose"></div>
      </div>
      <div class="input-group">
        <label>Status</label>
        <select class="status-select">
          <option value="">Nicht ausgewählt</option>
          <option value="implemented">Implementiert</option>
          <option value="partially-implemented">Teilweise implementiert</option>
          <option value="planned">Geplant</option>
          <option value="not-applicable">Nicht anwendbar</option>
        </select>
      </div>
      <div class="input-group">
        <label>Bemerkungen</label>
        <textarea class="comment-text"></textarea>
      </div>
    </div>`;

  /* Event-Handler für Part-Text */
  const matSel=div.querySelector('.maturity-select'),
        partSel=div.querySelector('.part-select'),
        proseDiv=div.querySelector('.part-prose'),
        update=()=>{
          const m=matSel.value,p=partSel.value;
          proseDiv.innerHTML=(maturityParts[m]?.[p]||'').replace(/\n/g,'<br>');
        };
  matSel.addEventListener('change',update);partSel.addEventListener('change',update);
  return div;
};

/* ======== Katalog rendern ======== */
const renderCatalog=()=>{
  try{catalogData=JSON.parse(jsonInput.value);}catch(e){
    statusEl.textContent=`Fehler: Ungültiges JSON – ${e.message}`;statusEl.style.color='red';return;}

  if(!catalogData?.catalog?.groups){
    statusEl.textContent='Fehler: catalog.groups fehlt.';statusEl.style.color='red';return;}

  treeViewContainer.innerHTML='';checklistContainer.innerHTML='';
  let controlCount=0;

  /* Haupt- & Untergruppen */
  catalogData.catalog.groups.forEach(main=>{
    const mDet=document.createElement('details');mDet.className='main-group';
    mDet.innerHTML=`<summary>${main.title||main.id}</summary>`;treeViewContainer.appendChild(mDet);

    (main.groups||[]).forEach(bs=>{
      const bDet=document.createElement('details');bDet.className='baustein-group';
      bDet.innerHTML=`<summary>${formatIdTitle(bs)}</summary>`;mDet.appendChild(bDet);

      (bs.controls||[]).forEach(ctrl=>{
        controlCount++;
        const cDet=document.createElement('details');cDet.className='bsi-control';
        cDet.dataset.level=findPropValue(ctrl.props,'level');
        cDet.dataset.phase=findPropValue(ctrl.props,'phase');

        const cSum=document.createElement('summary');cSum.textContent=formatIdTitle(ctrl);cDet.appendChild(cSum);

        const maturities=[];
        (ctrl.parts||[]).forEach(mp=>{
          if(mp.name==='maturity-level-description'){
            const level=findPropValue(mp.props,'maturity-level');maturities.push(level);
            const md=document.createElement('details');md.className='maturity-level-description';
            md.innerHTML=`<summary>${mp.title}</summary>`;
            (mp.parts||[]).forEach(p=>{
              const part=document.createElement('div');part.className='part-container';
              part.innerHTML=`<h4>${p.name.replace(/-/g,' ')}</h4><div class="prose">${(p.prose||'').replace(/\n/g,'<br>')}</div>`;
              md.appendChild(part);
            });
            cDet.appendChild(md);
          }
        });
        cDet.dataset.maturities=maturities.join(',');
        bDet.appendChild(cDet);

        checklistContainer.appendChild(renderChecklistItem(ctrl,main,bs));
      });
    });
  });

  filterControls.classList.remove('hidden');
  statusEl.textContent=`${controlCount} Anforderungen erfolgreich gerendert.`;statusEl.style.color='';
  applyFilters();
};

/* ======== Speichern / Laden, Filter ======== */
const saveState=()=>{ /* unverändert … */ };
const loadState=()=>{};
const applyFilters=()=>{
  if(!catalogData)return;
  const mat=maturityFilter.value,lev=levelFilter.value,ph=phaseFilter.value,
        view=document.querySelector('input[name="view-mode"]:checked').value;
  let checklistCount=0;

  const matcher=item=>{
    if(lev!=='all'&&item.dataset.level!==lev)return false;
    if(ph!=='all'&&item.dataset.phase!==ph)return false;
    if(mat==='all')return true;
    return (item.dataset.maturities||'').split(',').includes(mat);
  };

  document.querySelectorAll('.bsi-control').forEach(el=>el.classList.toggle('hidden',!matcher(el)));
  document.querySelectorAll('.checklist-item').forEach(el=>{
    const show=matcher(el);el.classList.toggle('hidden',!show);if(show)checklistCount++;
  });
  document.querySelectorAll('.main-group,.baustein-group').forEach(g=>{
    g.classList.toggle('hidden',!g.querySelector('.bsi-control:not(.hidden)'));
  });

  if(view==='tree'){
    treeViewContainer.classList.remove('hidden');
    checklistContainer.classList.add('hidden');saveLoadControls.classList.add('hidden');
    statusEl.textContent=`Zeige ${treeViewContainer.querySelectorAll('.bsi-control:not(.hidden)').length} passende Anforderungen im Baum.`;
  }else{
    treeViewContainer.classList.add('hidden');
    checklistContainer.classList.remove('hidden');saveLoadControls.classList.remove('hidden');
    statusEl.textContent=`Zeige ${checklistCount} passende Anforderungen in der Checkliste.`;
  }
};
const resetAll=()=>{maturityFilter.value=levelFilter.value=phaseFilter.value='all';
document.querySelector('input[value="tree"]').checked=true;applyFilters();};

/* ======== Events ======== */
renderBtn.addEventListener('click',renderCatalog);
resetBtn.addEventListener('click',resetAll);
maturityFilter.addEventListener('change',applyFilters);
levelFilter.addEventListener('change',applyFilters);
phaseFilter.addEventListener('change',applyFilters);
viewModeRadios.forEach(r=>r.addEventListener('change',applyFilters));
saveBtn&&saveBtn.addEventListener('click',saveState);
loadInput&&loadInput.addEventListener('change',loadState);

});
</script>
</body>
</html>
